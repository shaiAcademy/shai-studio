services:
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: shai
      POSTGRES_PASSWORD: shai
      POSTGRES_DB: shai_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - /home/almas_b/n8n/n8n_data/database.sqlite:/var/lib/docker/volumes/n8n_n8n_data/_data/database.sqlite:ro
        
    networks:
      default:
        aliases:
          - postgres
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U shai -d shai_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

  fastapi_api:
    build:
      context: ./fastapi_api
    container_name: fastapi_api
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql+psycopg2://shai:shai@postgres:5432/shai_db
      N8N_DB_PATH: /n8n_db/database.sqlite

      # RunPod Serverless
      RUNPOD_API_KEY: ${RUNPOD_API_KEY}
      RUNPOD_ENDPOINT_ID: ${RUNPOD_ENDPOINT_ID}

      # RunPod S3-compatible API (Network Volume)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      RUNPOD_S3_REGION: ${RUNPOD_S3_REGION}
      RUNPOD_S3_ENDPOINT_URL: ${RUNPOD_S3_ENDPOINT_URL}
      RUNPOD_VOLUME_ID: ${RUNPOD_VOLUME_ID}
      PRESIGN_EXPIRES_SEC: ${PRESIGN_EXPIRES_SEC:-86400}

      JWT_SECRET: ${JWT_SECRET:-change-me-please}
      JWT_EXPIRES_MIN: ${JWT_EXPIRES_MIN:-43200}
    volumes:
      - ./fastapi_api:/app
      - n8n_n8n_data:/n8n_db:ro
    ports:
      - "8000:8000"
    dns:
      - 1.1.1.1
      - 8.8.8.8
    networks:
      default:
        aliases:
          - fastapi_api
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  frontend_app:
    build:
      context: ./frontend_app
    container_name: frontend_app
    depends_on:
      - fastapi_api
    ports:
      - "3000:80"
    networks:
      default:
        aliases:
          - frontend_app

volumes:
  postgres_data:
  n8n_n8n_data:
    external: true    

networks:
  default:
    driver: bridge

